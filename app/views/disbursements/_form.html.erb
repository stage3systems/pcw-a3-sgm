<%= simple_form_for(@revision, url: disbursement_url(@disbursement),
                    method: :put, html: {class: "form-horizontal"}) do |f| %>
  <%= f.error_notification %>

  <div class="form-inputs">
    <div class="row-fluid">
    <div class="span4">
      <table class="table table-condensed table-bordered">
        <tbody>
          <tr>
            <th>Port</th>
            <td><%= @revision.data["port_name"] %></td>
          </tr>
          <% if @revision.data.has_key? 'terminal_name' %>
          <tr>
            <th>Terminal</th>
            <td><%= @revision.data["terminal_name"] %></td>
          </tr>
          <% end %>
          <tr>
            <th>Vessel</th>
            <td><%= @revision.data["vessel_name"] %></td>
          </tr>
          <tr>
            <th>GRT</th>
            <td><%= @revision.data["vessel_grt"] %></td>
          </tr>
          <tr>
            <th>NRT</th>
            <td><%= @revision.data["vessel_nrt"] %></td>
          </tr>
          <tr>
            <th>DWT</th>
            <td><%= @revision.data["vessel_dwt"] %></td>
          </tr>
          <tr>
            <th>LOA</th>
            <td><%= @revision.data["vessel_loa"] %></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="span4">
    <%= f.input :eta, label: 'ETA', as: :hidden %>
    <%= f.input :eta_picker, label: 'ETA', as: :fake %>
    <%= f.association :cargo_type,
                      label: "Cargo Type",
                      collection: @cargo_types,
                      label_method: :display %>
    <%= f.input :cargo_qty, label: "Cargo Quantity" %>
    <%= f.input :loadtime, label: "Load Time (Hours)" %>
    <%= f.input :days_alongside, label: "Days Alongside" %>
    </div>
    <div class="span4">
    <%= f.input :tugs_in, label: "Tugs In" %>
    <%= f.input :tugs_out, label: "Tugs Out" %>
    <%= f.input :tax_exempt, label: "Tax Exempt" %>
    </div>
    <div class="clearfix"></div>
    </div>
    <h4>Services</h4>
    <div class="overriden">
    </div>
    <table class="disbursement table table-bordered table-condensed">
      <thead>
        <tr>
          <th>Name</th>
          <th>Amount (<%= @revision.data["currency_code"] %>)</th>
          <th class="tax_inc tax">Amount (<%= @revision.data["currency_code"] %>) Tax Included</th>
          <th>Disable</th>
        </tr>
      </thead>
      <tbody>
        <% @revision.field_keys.each do |k| %>
          <tr class="service<% if not @revision.compulsory?(k) and @revision.disabled?(k) %> muted<% end %>" id="service_<%= k %>">
            <th>
              <%= @revision.descriptions[k] %>
              <% if k.starts_with? "EXTRAITEM" %>
                &nbsp;<i class="icon-remove-circle" onclick="removeExtra('<%= k %>')"></i>
              <% end %>
              &nbsp;<span class="editable_value" id="comment_<%= k %>"><%= @revision.comments[k] rescue '' %></span>
            </th>
            <td id="service_<%= k %>">
              <a class="editable_value" id="field_<%= k %>" title="Click to override" href="#"></a>&nbsp;<i class="hidden icon-remove-circle" onclick="revertValue('<%= k %>')"></i>
              <input type="hidden" name="overriden_<%= k %>"
              <% if @revision.overriden.has_key?(k) %>
                     value="<%= @revision.overriden[k] %>"
              <% end %>
              />
              <input type="hidden" name="value_<%= k %>" />
              <input  type="hidden" name="value_with_tax_<%= k %>" />
              <input  type="hidden" name="comment_<%= k %>" value="<%= @revision.comments[k] %>"/>
              <input  type="hidden" name="disabled_<%= k %>" value="<%= @revision.disabled?(k) ? "1" : "0" %>" />
            </td>
            <td id="service_with_tax_<%= k %>" class="tax"></td>
            <td><% unless @revision.compulsory?(k) %><input class="disable" type="checkbox" name="disable_<%= k %>" <% if @revision.disabled?(k) %>checked="checked"<% end %> /><% end %></td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <td><input id="extra_item" />&nbsp;Tax Applies: <input type="checkbox" id="extra_tax_applies" /></td>
          <td><a id="add_item" class="btn btn-small btn-success" href="javascript:void(0)">Add Item</a></td>
          <td class="tax"></td>
          <td></td>
        </tr>
        <tr>
          <th>TOTAL</th>
          <th class="total"></th>
          <th class="total_tax_inc tax"></th>
          <th></th>
        </tr>
      </tfoot>
    </table>

  <div class="form-actions">
    <div class="btn-group">
    <%= f.submit "Save PFDA", class: "btn btn-primary" %>
    <% if @revision.number == 0 %>
    <%= link_to "Cancel",
                @disbursement,
                method: :delete,
                class: "btn" %>
    <% else %>
    <%= link_to "Cancel", disbursements_path, class: "btn" %>
    <% end %>
    </div>
  </div>
<% end %>
<script type="text/javascript">
  $(document).ready(function() {
    window.revisionId = <%= @revision.id %>;
    var numItems = <%= @revision.field_keys.count %>;
    var cargoTypes = {
    <% @cargo_types.each do |ct| %>
      "<%= ct.id %>": <%= ct.to_json.html_safe %><%= "," unless ct == @cargo_types.last %>
    <% end %>
    }
    $.fn.editable.defaults.mode = 'inline';
    var convert = function(n) {
      return numberToCurrency(parseFloat(n), {unit: '<%= @revision.data["currency_symbol"] %>'});
    };
    window.removeExtra = function(key) {
      $("tr#service_"+key).remove();
      ctx.services = $.grep(ctx.services, function(value) {
        return value != key;
      });
      update();
    };
    window.revertValue = function(key) {
      $("td#service_"+key+" a").editable('setValue', ctx.computed[key]);
      delete ctx.values[key];
      delete ctx.overriden[key];
      $('input[name="overriden_'+key+'"]').val('');
      $("td#service_"+key+" a.editable_value").removeClass("editable-unsaved");
      $("td#service_"+key+" i").addClass("hidden");
      update();
    };
    var valueDisplay = function(value, sourceData) {
      var key = $(this).attr("id").split("_")[1];
      var val = normalizeValue(value);
      ctx.overriden[key] = val;
      $('input[name="overriden_'+key+'"]').val(val);
      $(this).html(convert(val));
      update();
    };
    var uuid = function() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
          return v.toString(16);
      });
    };
<%= @revision.context.html_safe %>
    window.getCtx = function() { return ctx; };
    var update = function() {
      ctx.estimate.eta = new Date($("input#disbursement_revision_eta").val());
      ctx.estimate.cargo_qty = parseInt($("input#disbursement_revision_cargo_qty").val());
      ctx.estimate.tugs_in = parseInt($("input#disbursement_revision_tugs_in").val()),
      ctx.estimate.tugs_out = parseInt($("input#disbursement_revision_tugs_out").val()),
      ctx.estimate.loadtime = parseInt($("input#disbursement_revision_loadtime").val()),
      ctx.estimate.days_alongside = parseFloat($("input#disbursement_revision_days_alongside").val())
      parseCodes(ctx);
      compute(ctx);
      var n = ctx.services.length,
          i = -1;
      while (++i < n) {
        var key = ctx.services[i];
        $("td#service_"+key+" a").html(convert(ctx.values[key]));
        $("td#service_"+key+" a").attr("data-value", ctx.values[key]);
        $("td#service_with_tax_"+key).html(convert(ctx.values_with_tax[key]));
        $('input[name="value_'+key+'"]').val(ctx.values[key]);
        $('input[name="value_with_tax_'+key+'"]').val(ctx.values_with_tax[key]);
        if ((key in ctx.overriden) && key.indexOf("EXTRAITEM") != 0) {
          $("td#service_"+key+" i").removeClass("hidden");
          $("td#service_"+key+" a").addClass("editable-unsaved");
        }
      }
      $("th.total").html(convert(ctx.total));
      $("th.total_tax_inc").html(convert(ctx.totalTaxInc));
      $("th span.editable_value").editable({
            display: function(value, sourceData) {
                        var key = $(this).attr("id").split("_")[1];
                        $(this).html(value);
                        $('input[name="comment_'+key+'"]').val(value);
                        },
            emptytext: 'Click to add Comment'
      });
      $("td a.editable_value").editable({display: valueDisplay});
    }
    var cleanCompute = function() {
      $("a.editable_value").removeClass("editable-unsaved");
      update();
    };
    $("input#disbursement_revision_cargo_qty").on("change", cleanCompute);
    $("input#disbursement_revision_tugs_in").on("change", cleanCompute);
    $("input#disbursement_revision_tugs_out").on("change", cleanCompute);
    $("input#disbursement_revision_loadtime").on("change", cleanCompute);
    $("input#disbursement_revision_days_alongside").on("change", cleanCompute);
    var handleTaxExempt = function() {
      var taxExempt = $("input#disbursement_revision_tax_exempt").is(':checked');
      if (taxExempt) {
        $(".tax").hide();
      } else {
        $(".tax").show();
      }
      update();
    };
    $("input#disbursement_revision_tax_exempt").on('change', handleTaxExempt);
    $("select#disbursement_revision_cargo_type_id").on('change', function() {
        var ctId = $("select#disbursement_revision_cargo_type_id").val();
        var cargoType = cargoTypes[ctId];
        if (cargoType) {
          ctx.cargo_type.type = cargoType.maintype;
          ctx.cargo_type.subtype = cargoType.subtype;
          ctx.cargo_type.subsubtype = cargoType.subsubtype;
          ctx.cargo_type.subsubsubtype = cargoType.subsubsubtype;
        }
        update();
    });
    $("a#add_item").on("click", function(e) {
        var item = $("input#extra_item").val();
        if (item) {
          var key = 'EXTRAITEM'+uuid();
          var taxApplies = $("input#extra_tax_applies").is(":checked");
          ctx.services[numItems] = key;
          ctx.codes[key] = '{compute: function(ctx) {return 0;},'
                           +'taxApplies: '+taxApplies+'}';
          ctx.values[key] = 0;
          ctx.compulsory[key] = false;
          ctx.computed[key] = "0";
          ctx.overriden[key] = "0";
          $("table.disbursement tbody").append(
              '<tr class="service" id="service_'+key+'">'
               +'<th>'+item+'&nbsp;<i class="icon-remove-circle" '
                                    +'onclick="removeExtra(\''+key+'\')"></i>'
                    +'&nbsp;<span class="editable_value" '
                                +'id="comment_'+key+'"></span>'
               +'</th>'
               +'<td id="service_'+key+'">'
                 +'<a class="editable_value" id="field_'+key+'" '
                    +'title="Click to override" href="#"></a>&nbsp;'
                 +'<i class="hidden icon-remove-circle" '
                    +'onclick="revertValue(\''+key+'\')"></i>'
                 +'<input type="hidden" name="overriden_'+key+'" />'
                 +'<input type="hidden" name="value_'+key+'" />'
                 +'<input type="hidden" name="value_with_tax_'+key+'" '
                        +'value="0" />'
                +'<input type="hidden" name="code_'+key+'" '
                       +'value="'+ctx.codes[key]+'" />'
                +'<input type="hidden" name="description_'+key+'" '
                       +'value="'+item+'" />'
                 +'<input type="hidden" name="comment_'+key+'" />'
                 +'<input  type="hidden" name="disabled_'+key+'" value="0" />'
               +'</td>'
               +'<td id="service_with_tax_'+key+'" class="tax"></td>'
               +'<td><input class="disable" type="checkbox" '
                          +'name="disable_'+key+'" /></td>'
             +'</tr>');
          $("input#extra_item").val("");
          $("input#extra_tax_applies").removeAttr("checked");
          numItems += 1;
          handleTaxExempt();
          setupDisableListeners();
        }
    });
    var setupDisableListeners = function() {
        $("input.disable").on("change", function(e) {
            var key = $(e.target).attr("name").split('_')[1],
                disabled = $(e.target).is(":checked");
            if (disabled) {
                $('tr.service#service_'+key).addClass('muted');
            } else {
                $('tr.service#service_'+key).removeClass('muted');
            }
            $('input[name="disabled_'+key+'"]').val(disabled ? "1" : "0");
            ctx.disabled[key] = disabled;
            update();
        });
    };
    setupDisableListeners();
    $("select.date").on("change", update);
    handleTaxExempt();
    $("input#eta_picker").datepicker({
      dateFormat: "dd M yy",
      altField: "input#disbursement_revision_eta",
      altFormat: "yy-mm-dd"
    })
    $("input#eta_picker").datepicker(
      "setDate", new Date($("input#disbursement_revision_eta").val()));
    $("input#eta_picker").on("change", update);
  });
</script>
