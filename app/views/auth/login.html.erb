<div class="row">
  <div class="col-md-12">
    <% unless (browser.ie? and
               browser.version.to_i < 10 and params[:force].nil?) or
                params[:browser_check] %>
    <div class="login-container">
      <% flash.each do |name, msg| %>
      <% unless name == :timedout or msg.class != String %>
      <div class="alert alert-<%= name == :notice ? "info" : "danger" %>">
        <% unless name == :notice %><strong>Oops!<%= name %></strong> <% end %><%= msg %>
      </div>
      <% end %>
      <% end %>

      <h1>PDA Estimator</h1>
      <div class="spinner">
        <h1 class="text-center"><span class="fa fa-spinner fa-spin"></span></h1>
      </div>
      <div class="identity-choice" style="display: none;">
        <button id="continue" class="btn blue">Continue as <span class="username">...</span></button>
        <button id="signin" class="btn blue">Sign in with a different account</button>
      </div>
      <div class="login" style="display: none;">
        <label class="sr-only" for="">Username</label>
        <input type="text" name="user[login]" placeholder="Username" class="username">
        <label class="sr-only" for="">Password</label>
        <input type="password" name="user[password]" placeholder="Password" class="password">
        <button class="btn blue" id="submit">Log In</button>
      </div>
      <p class="forgot-pass">
        <a href="https://stage3systems.zendesk.com/home">Trouble logging in?</a>
      </p>
    </div>
    <div class="login-footer">
      &copy;2013-2015 Stage 3 Systems Inc. <a href="http://stage3systems.com/tos.html">Terms of Service</a>
    </div>
    <% else %>
    <div class="col-md-10 col-md-offset-1 browsers">
      <h2 class="title">Please Upgrade Your Browser</h2>
      <p>This service uses the latest web technologies to make it faster
         and easier to use.
         Unfortunately, your browser does not support these technologies.</p>
         <p>Please download or upgrade to one of the following browsers and
            you will be on your way.</p>

      <ul class="row">
        <li class="col-md-6 ff">
          <a href="http://www.mozilla.org/en-US/firefox/new/"
             target="_blank">
            <span>Mozilla Firefox</span> Version 4 or higher
          </a>
        </li>
        <li class="col-md-6 safari">
          <a href="http://support.apple.com/kb/dl1531"
             target="_blank">
            <span>Apple Safari</span> Version 5 or higher
          </a>
        </li>
      </ul>
      <ul class="row">
        <li class="col-md-6 chrome">
          <a href="https://www.google.com/intl/en/chrome/browser/"
             target="_blank">
            <span>Google Chrome</span> Version 4 or higher
        </a>
        </li>
        <li class="col-md-6 ie">
          <a href="http://windows.microsoft.com/en-US/internet-explorer/download-ie"
             target="_blank">
            <span>Internet Explorer</span> Version 10 or higher
         </a>
        </li>
      </ul>

      <p class="ignore-browser">
        <%= link_to "I know what I'm doing, let me in Â»",
                    new_user_session_path(force: 1) %></p>
    </div>
    <% end %>
  </div>
</div>
<script type="text/javascript">
  var auth0 = new Auth0({
    domain: '<%= @domain %>',
    clientID: '<%= @client_id %>'
  });
  var clearError = function() {
    $('div.alert-danger').remove();
  };
  var showError = function(txt) {
    clearError();
    $('<div class="alert alert-danger">'+
        '<strong>Oops!</strong> '+txt+
      '</div>').insertBefore('div.login-container h1');
  };

  var setupLogin = function() {
    $('input').val('');
    $('input').on('keypress', function(e) {
      var keycode = (e.keyCode ? e.keyCode : e.which);
      if (keycode === 13) logIn();
    });
    $('button#submit').removeAttr('disabled');
    $('button#submit').on('click', logIn);
  }

  var xdStorage = new CDStorage('<%= @rocket_url %>', '/crossdomain.html');
  getToken(xdStorage, function(err, token) {
    $.post('/auth/check', {token: token})
      .done(function(data) {
        $("div.spinner").fadeOut(100);
        if (data.user) {
          $("span.username").html(data.user.name);
          $("div.identity-choice").fadeIn(100);
          $("button#continue").on("click", function() {
            $(this).html($('<span class="fa fa-spinner fa-spin"></span>'));
            $(this).attr('disabled', 'disabled');
            $.post('/auth/register',
                   {token: token})
              .done(function() {
                setToken(xdStorage, token);
                window.location = "<%= root_path %>";
              })
              .fail(function() {
                showError('An error prevented login. Please try again or contact support');
              });
          });
          $("button#signin").on("click", function() {
            $("div.identity-choice").fadeOut(100);
            $("div.login").fadeIn(100, setupLogin);
          });
        } else {
          $("div.login").fadeIn(100, setupLogin);
        }
      });
  });

  var logIn = function() {
    var button = $('button#submit');
    var username = $('input[name="user[login]"]').val();
    var password = $('input[name="user[password]"]').val();
    if (username == '' && password == '') return;
    $(button).html($('<span class="fa fa-spinner fa-spin"></span>'));
    $(button).attr('disabled', 'disabled');
    username += '.<%= @tenant %>';
    auth0.login({
      connection: '<%= @connection %>',
      username: username,
      password: password
    }, function (err, profile, id_token, access_token) {
      if (err) {
        showError('Invalid user name or password.');
        $(button).html('Log In');
        $(button).removeAttr('disabled');
        return;
      }
      $.post('/auth/register',
             {token: id_token})
        .done(function(r) {
          setToken(xdStorage, id_token);
          window.location = "<%= root_path %>";
        })
        .fail(function() {
          showError('An error prevented login. Please try again or contact support');
        });
    });
  }
</script>
<script type="text/javascript">
window.toggle_login = function() {
  $("div.browser-upgrade").hide();
  $("div.login").show();
};
</script>
